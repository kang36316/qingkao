<?phpnamespace app\api\controller;use app\common\controller\IndexBase;use app\api\controller\Login;use app\common\extend\wechat\WechatJsapi;class Author  extends IndexBase{    public function injectionAuthocode(){        $post=input('post.');        $data = [];        foreach ($post as $k => $v) {            $data[] = ['name' => $k, 'value' => $v];        }        if ($this->saveAll('system', $data) === true) {            clear_cache();        }    }    public function injectionServer(){        $post=input('post.');        $data = [];        foreach ($post as $k => $v) {            $data[] = ['name' => $k, 'value' => $v];        }        if ($this->saveAll('system', $data) === true) {            clear_cache();            $res['code']=0;        }else{            $res['code']=1;        }        echo json_encode($res);    }    public function appLogin(){        $data=$this->wechatAPPConfig();        $WechatJsapi=new WechatJsapi($data);        $WechatJsapi->getCode(is_https().get_domain().'/index/course/getcode/type/login','snsapi_userinfo');    }    public function appcallbac(){        $param = $this->request->param();        $data=$this->wechatAPPConfig();        $WechatJsapi=new WechatJsapi($data);        $AccessToken=$WechatJsapi->getAccessToken($param['code']);        $userInfo=$WechatJsapi->getUserInfo($AccessToken['access_token'],$AccessToken['openid']);        $this->login($userInfo,'wx');    }    public function thirdLogin(){        $param = $this->request->param();        $name =$param['type'];        if($name=='weixin'){            $WeixinConfig = $this->getWeixinLoginConfig();            $config['app_id']=$WeixinConfig['weixin_app_id'];            $config['app_secret']=$WeixinConfig['weixin_app_secret'];        }        if($name=='qq'){            $QqConfig = $this->getQqLoginConfig();            $config['app_id']=$QqConfig['qq_app_id'];            $config['app_key']=$QqConfig['qq_app_key'];        }        $login = Login::getApp($name,$config);        $login->login();    }    public function wxcallbak(){        $WeixinConfig = $this->getWeixinLoginConfig();        $config['app_id']=$WeixinConfig['weixin_app_id'];        $config['app_secret']=$WeixinConfig['weixin_app_secret'];        $login = Login::getApp('weixin',$config);        $userinfo=$login->getUserInfo();        $this->login($userinfo,'wx');    }    public function qqcallbak(){        $QqConfig = $this->getQqLoginConfig();        $config['app_id']=$QqConfig['qq_app_id'];        $config['app_key']=$QqConfig['qq_app_key'];        $login = Login::getApp('qq',$config);        $userinfo=$login->getUserInfo();        $this->login($userinfo,'qq');    }    public function login($userinfo,$type){        $user = model('user')->where(['openid' => $userinfo['unionid']])->find();        if(!$user){            if($type=='qq'){                $data['openid']=$userinfo['openid'];                $data['username']=$userinfo['nickname'];                $data['sex']=$userinfo['gender']=='男'? 1:0;                $data['avatar']=$userinfo['figureurl_qq'];                $data['create_time']=time();                $data['login_count']=1;                $data['status']=1;            }            if($type=='wx'){                $data['openid']=$userinfo['unionid'];                $data['username']=$userinfo['nickname'];                $data['sex']=$userinfo['sex'];                $data['avatar']=$userinfo['headimgurl'];                $data['create_time']=time();                $data['login_count']=1;                $data['status']=1;            }            $id=db('user')->insertGetId($data);            $user = model('user')->where(['id' => $id])->find();        }        $user['status'] != 1 && $this->error('账号已禁用');        $auth = [            'user_id' => $user['id'],            'username' => $user['username'],        ];        session('user_auth', $auth);        session('user_auth_sign', data_auth_sign($auth));        model('user')->save([            'last_login_time' => time(),            'last_login_ip'   => $this->request->ip(),            'login_count'     => $user['login_count'] + 1,        ], ['id' => $user['id']]);        if($user['is_teacher']==1){            $adminauth = [                'admin_id' => $user['admin_id'],                'username' => $user['username'],            ];            session('admin_auth', $adminauth);            session('admin_auth_sign', data_auth_sign($adminauth));        }        if($returnUrl = session('returnUrl')) {            $this->redirect( $returnUrl);        }else{            $this->redirect(url('index/user/index'));        }    }    /**     * 发送注册验证码     */    function regCode(){        $param = $this->request->param();        $code = rand_number(5);        session('telphoneCode',$code);        session('telphone',$param['mobile']);        $templateParam = array("code"=>$code);        $templateCode=unserialize(config('SmsTemplates_MC'));        $config['KeyID']=config('KeyID');        $config['KeySecret']=config('KeySecret');        $config['SmsSign']=config('SmsSign');        if(empty($config['KeyID']) || empty($config['KeySecret']) ||empty($config['SmsSign'])){            $res=['Code'=>1,'Message'=>'请先配置阿里云点播参数'];        }elseif(empty($templateCode) || empty($templateCode['TemplatesId'])){            $res=['Code'=>1,'Message'=>'请先配置阿里云短信模板'];        }else{            $res=sendSMS($param['mobile'],$templateParam,$templateCode['TemplatesId'],$config);        }        echo json_encode($res);    }}